<!-- ======================================================
     DIGIY EXPLORE ‚Äî LISTING (PUBLIC) ‚Äî explore.html (V2)
     Style: Netflix cards (cover + overlay + bottom text)
     Data: public.digiy_explore_spots (status='published')
====================================================== -->
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#071a13" />
  <title>DIGIY EXPLORE ‚Äî Explorer</title>
  <meta name="description" content="D√©couvre les meilleurs spots DIGIY : resto, plage, culture, nature, h√©bergement, activit√©s." />

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#071a13; --card:#0b2a1f; --card2:#0a241b;
      --line:rgba(255,255,255,.12);
      --text:#eafff1; --muted:rgba(234,255,241,.70);
      --gold:#facc15; --orange:#f59e0b; --green:#22c55e; --danger:#fb7185;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --r:18px; --r2:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 480px at 12% 10%, rgba(250,204,21,.12), transparent 60%),
        radial-gradient(900px 480px at 88% 90%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, #020617 100%);
      overflow-x:hidden;
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 14px 34px}

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      padding:10px 12px;
      border:1px solid var(--line);
      background:rgba(11,42,31,.65);
      backdrop-filter: blur(10px);
      border-radius:22px;
      box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:30;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:38px;height:38px;border-radius:14px;
      display:grid;place-items:center;
      background:
        radial-gradient(circle at 30% 30%, rgba(250,204,21,.35), transparent 55%),
        linear-gradient(135deg, rgba(34,197,94,.30), rgba(245,158,11,.25));
      border:1px solid rgba(255,255,255,.15);
      font-weight:900;
    }
    .brand .t1{margin:0;font-size:14px;font-weight:900;letter-spacing:.3px}
    .brand .t2{margin:2px 0 0;font-size:12px;color:rgba(234,255,241,.65)}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(6,20,18,.55);
      cursor:pointer;
      font-size:12px;
      user-select:none;
      white-space:nowrap;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
    }
    .btn:active{transform:scale(.98)}
    .btn.primary{background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.22)}
    .btn.gold{background: rgba(250,204,21,.12); border-color: rgba(250,204,21,.22)}
    .btn.ghost{background: rgba(0,0,0,.20)}
    .btn.small{padding:8px 10px;font-size:12px}

    .hero{
      margin-top:14px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      background: rgba(11,42,31,.30);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .heroIn{padding:14px 14px 12px}
    .hTitle{font-weight:1000;font-size:18px;letter-spacing:.2px}
    .hSub{margin-top:6px;color:rgba(234,255,241,.70);font-size:13px;line-height:1.35}

    .controls{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1.3fr .9fr .9fr .9fr;
      gap:10px;
      align-items:center;
    }
    @media (max-width:980px){ .controls{grid-template-columns:1fr 1fr; } }
    @media (max-width:540px){ .controls{grid-template-columns:1fr; } }

    .field{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(6,20,18,.45);
      border-radius: 16px;
      padding:10px 10px;
      display:flex; align-items:center; gap:10px;
    }
    .field input, .field select{
      width:100%;
      background:transparent;
      border:0;
      outline:none;
      color:var(--text);
      font-size:13px;
      appearance:none;
    }
    .field label{font-size:12px;color:rgba(234,255,241,.65);white-space:nowrap}

    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.16);
      font-size:12px;
      color:rgba(234,255,241,.86);
      cursor:pointer;
      user-select:none;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
    }
    .chip:active{transform:scale(.98)}
    .chip.on{border-color: rgba(250,204,21,.32); background: rgba(250,204,21,.10);}

    .statsRow{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      margin-top:12px;
    }
    .stat{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.16);
      font-size:12px;
      color:rgba(234,255,241,.86);
    }

    /* ==========================
       GRID + NETFLIX CARDS V2
       ========================== */
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
    }
    @media (max-width:980px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width:560px){ .grid{grid-template-columns: 1fr;} }

    .card{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(11,42,31,.55);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
      transform: translateZ(0);
    }
    .card:hover{border-color: rgba(250,204,21,.16)}
    .cover{
      position:relative;
      height: 185px;
      background:
        radial-gradient(700px 260px at 20% 20%, rgba(250,204,21,.18), transparent 55%),
        radial-gradient(700px 260px at 80% 80%, rgba(34,197,94,.16), transparent 55%),
        linear-gradient(135deg, rgba(6,20,18,.55), rgba(0,0,0,.35));
      overflow:hidden;
    }
    .cover img{
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:center;
      display:block;
      transform:scale(1.06);
      filter:saturate(1.05) contrast(1.05);
    }
    .cover::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(
        180deg,
        rgba(0,0,0,.05) 0%,
        rgba(0,0,0,.22) 45%,
        rgba(0,0,0,.78) 100%
      );
      pointer-events:none;
    }

    .topBadges{
      position:absolute;
      top:10px; left:10px; right:10px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      z-index:2;
    }
    .tagBadge{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      font-size:12px;
    }
    .dot{width:9px;height:9px;border-radius:999px;background:rgba(255,255,255,.35)}
    .open .dot{background:var(--green)}
    .boost .dot{background:var(--orange)}
    .closed .dot{background:var(--danger)}

    .bottomText{
      position:absolute;
      left:0; right:0; bottom:0;
      padding:12px 12px 12px;
      z-index:2;
    }
    .title{
      font-weight:1000;
      font-size:16px;
      line-height:1.15;
      text-shadow: 0 6px 18px rgba(0,0,0,.55);
    }
    .meta{
      margin-top:6px;
      color:rgba(234,255,241,.78);
      font-size:12px;
      line-height:1.25;
    }
    .pills{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .pill{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      font-size:12px;
      color:rgba(234,255,241,.90);
      backdrop-filter: blur(10px);
    }

    .cardIn{
      padding:12px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .desc{
      color:rgba(234,255,241,.72);
      font-size:13px;
      line-height:1.35;
    }
    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:2px;
    }

    .empty{
      margin-top:14px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius: var(--r);
      padding:16px;
      background: rgba(0,0,0,.18);
      color:rgba(234,255,241,.85);
      text-align:center;
      line-height:1.4;
    }

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:14px; z-index:80;
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(234,255,241,.92);
      padding:10px 12px;
      border-radius: 999px;
      backdrop-filter: blur(10px);
      display:none;
      max-width:min(94vw, 720px);
      box-shadow: var(--shadow);
      font-size:13px;
    }
    .toast.show{display:block}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">‚ôæÔ∏è</div>
        <div>
          <div class="t1">DIGIY EXPLORE</div>
          <div class="t2">Vitrine ‚Äî Spots publi√©s (V2)</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
        <a class="btn ghost" href="./explore.html">üß≠ Explorer</a>
        <a class="btn gold" href="./spot.html?slug=chez-astou-saly">‚≠ê Exemple</a>
      </div>
    </div>

    <div class="hero">
      <div class="heroIn">
        <div class="hTitle">Trouve un spot terrain en 2 secondes.</div>
        <div class="hSub">Contact direct. Infos utiles. Itin√©raire. Une vitrine simple, rapide, propre.</div>

        <div class="controls">
          <div class="field">
            <label>üîé</label>
            <input id="q" type="search" placeholder="Rechercher : Chez Astou, Saly, plage, tags‚Ä¶" autocomplete="off">
          </div>

          <div class="field">
            <label>Type</label>
            <select id="type">
              <option value="">Tous</option>
              <option value="resto">resto</option>
              <option value="plage">plage</option>
              <option value="culture">culture</option>
              <option value="nature">nature</option>
              <option value="hebergement">hebergement</option>
              <option value="activite">activite</option>
            </select>
          </div>

          <div class="field">
            <label>Budget</label>
            <select id="budget">
              <option value="">Tous</option>
              <option value="petit">petit</option>
              <option value="moyen">moyen</option>
              <option value="premium">premium</option>
            </select>
          </div>

          <div class="field">
            <label>Tri</label>
            <select id="sort">
              <option value="score_desc">Score ‚Üì</option>
              <option value="new_desc">Nouveau ‚Üì</option>
              <option value="az">A ‚Üí Z</option>
            </select>
          </div>
        </div>

        <div class="chips" id="quickChips"></div>

        <div class="statsRow">
          <div class="stat" id="statLine">Chargement‚Ä¶</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <div class="btn small ghost" id="btnReload">üîÑ Recharger</div>
            <div class="btn small gold" id="btnCopyUrl">üîó Copier lien filtre</div>
          </div>
        </div>
      </div>
    </div>

    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none"></div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ===============================
   SUPABASE (HARDCODED)
================================ */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

/* ===============================
   HELPERS
================================ */
const $ = (s)=>document.querySelector(s);
const toastEl = $("#toast");
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 2800);
}
function esc(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function normalizePhone(p){
  if(!p) return "";
  return (p+"").trim().replace(/[^\d+]/g,"");
}
function buildWhatsAppLink(phone, title){
  const p = normalizePhone(phone).replace(/\+/g,"");
  if(!p) return "";
  const txt = encodeURIComponent(`Bonjour üëã Je viens de voir "${title||"votre spot"}" sur DIGIY EXPLORE. Je veux des infos svp.`);
  return `https://wa.me/${p}?text=${txt}`;
}
function buildMapsLink(lat,lng,title){
  if(!isFinite(lat) || !isFinite(lng)) return "";
  const q = encodeURIComponent(`${lat},${lng} (${title||"Spot"})`);
  return `https://www.google.com/maps?q=${q}`;
}
function qs(k){ return new URL(location.href).searchParams.get(k); }
function setQs(params){
  const u = new URL(location.href);
  Object.entries(params).forEach(([k,v])=>{
    if(v===null || v===undefined || v==="") u.searchParams.delete(k);
    else u.searchParams.set(k, v);
  });
  history.replaceState({}, "", u.toString());
}
function getSb(){
  if(!window.supabase?.createClient) throw new Error("Supabase JS not loaded");
  return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:false } });
}
const sb = getSb();

/* Placeholder SVG (fallback image if broken URL) */
const IMG_FALLBACK = `data:image/svg+xml;utf8,` + encodeURIComponent(`
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="700">
  <defs>
    <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
      <stop offset="0" stop-color="#0b2a1f"/>
      <stop offset="1" stop-color="#020617"/>
    </linearGradient>
  </defs>
  <rect width="100%" height="100%" fill="url(#g)"/>
  <text x="50%" y="46%" text-anchor="middle" font-size="44" fill="#eafff1" font-family="Arial" font-weight="800">‚ôæÔ∏è DIGIY EXPLORE</text>
  <text x="50%" y="56%" text-anchor="middle" font-size="26" fill="rgba(234,255,241,.70)" font-family="Arial">Photo indisponible</text>
</svg>
`);

/* ===============================
   STATE
================================ */
let ALL = [];
let filtered = [];

const TYPES = ["resto","plage","culture","nature","hebergement","activite"];
const QUICK = [
  {k:"type", v:"resto", label:"üçΩÔ∏è Resto"},
  {k:"type", v:"plage", label:"üèñÔ∏è Plage"},
  {k:"type", v:"culture", label:"üèõÔ∏è Culture"},
  {k:"type", v:"nature", label:"üåø Nature"},
  {k:"type", v:"hebergement", label:"üè† H√©bergement"},
  {k:"type", v:"activite", label:"‚ö° Activit√©s"},
  {k:"budget", v:"petit", label:"üí∏ Petit"},
  {k:"budget", v:"moyen", label:"üí∞ Moyen"},
  {k:"budget", v:"premium", label:"üëë Premium"},
];

/* ===============================
   UI INIT
================================ */
function renderQuickChips(){
  const box = $("#quickChips");
  box.innerHTML = QUICK.map(c=>`<div class="chip" data-k="${c.k}" data-v="${c.v}">${esc(c.label)}</div>`).join("");
  box.querySelectorAll(".chip").forEach(ch=>{
    ch.onclick = ()=>{
      const k = ch.getAttribute("data-k");
      const v = ch.getAttribute("data-v");
      if(k==="type") $("#type").value = ($("#type").value===v ? "" : v);
      if(k==="budget") $("#budget").value = ($("#budget").value===v ? "" : v);
      applyFilters(true);
    };
  });
}

function readUrlFilters(){
  const q = (qs("q")||"").trim();
  const type = (qs("type")||"").trim();
  const budget = (qs("budget")||"").trim();
  const sort = (qs("sort")||"score_desc").trim();

  $("#q").value = q;
  $("#type").value = TYPES.includes(type) ? type : "";
  $("#budget").value = ["petit","moyen","premium"].includes(budget) ? budget : "";
  $("#sort").value = ["score_desc","new_desc","az"].includes(sort) ? sort : "score_desc";
}

function writeUrlFilters(){
  setQs({
    q: ($("#q").value||"").trim(),
    type: ($("#type").value||"").trim(),
    budget: ($("#budget").value||"").trim(),
    sort: ($("#sort").value||"").trim(),
  });
}

/* ===============================
   DATA LOAD
================================ */
async function loadSpots(){
  $("#statLine").textContent = "Chargement‚Ä¶";

  const { data, error } = await sb
    .from("digiy_explore_spots")
    .select("id, created_at, name, slug, type, zone, city, lat, lng, badge, description, photo_url, phone, link_url, status, duree, budget, tags, score")
    .eq("status","published")
    .limit(500);

  if(error){
    console.error("SUPABASE ERROR:", error);
    $("#grid").innerHTML = "";
    $("#empty").style.display = "block";
    $("#empty").innerHTML = `‚ùå Erreur lecture (RLS / table).<br><span style="opacity:.8">Ouvre Console (F12) pour voir le d√©tail.</span>`;
    $("#statLine").textContent = "Erreur";
    toast("Erreur lecture (Supabase/RLS)");
    return;
  }

  ALL = Array.isArray(data) ? data : [];
  applyFilters(false);
}

/* ===============================
   FILTER + SORT
================================ */
function spotText(s){
  const tags = Array.isArray(s.tags) ? s.tags.join(" ") : "";
  return `${s.name||""} ${s.type||""} ${s.zone||""} ${s.city||""} ${tags}`.toLowerCase();
}

function applyFilters(pushUrl){
  const q = ($("#q").value||"").trim().toLowerCase();
  const type = ($("#type").value||"").trim();
  const budget = ($("#budget").value||"").trim();
  const sort = ($("#sort").value||"score_desc").trim();

  if(pushUrl) writeUrlFilters();

  filtered = ALL.filter(s=>{
    if(type && (s.type||"") !== type) return false;
    if(budget && (s.budget||"") !== budget) return false;
    if(q){
      if(!spotText(s).includes(q)) return false;
    }
    return true;
  });

  <!-- ======================================================
     DIGIY EXPLORE ‚Äî LISTING (PUBLIC) ‚Äî explore.html (V2)
     Style: Netflix cards (cover + overlay + bottom text)
     Data: public.digiy_explore_spots (status='published')
====================================================== -->
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#071a13" />
  <title>DIGIY EXPLORE ‚Äî Explorer</title>
  <meta name="description" content="D√©couvre les meilleurs spots DIGIY : resto, plage, culture, nature, h√©bergement, activit√©s." />

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#071a13; --card:#0b2a1f; --card2:#0a241b;
      --line:rgba(255,255,255,.12);
      --text:#eafff1; --muted:rgba(234,255,241,.70);
      --gold:#facc15; --orange:#f59e0b; --green:#22c55e; --danger:#fb7185;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --r:18px; --r2:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 480px at 12% 10%, rgba(250,204,21,.12), transparent 60%),
        radial-gradient(900px 480px at 88% 90%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, #020617 100%);
      overflow-x:hidden;
    }
    a{color:inherit; text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:16px 14px 34px}

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      padding:10px 12px;
      border:1px solid var(--line);
      background:rgba(11,42,31,.65);
      backdrop-filter: blur(10px);
      border-radius:22px;
      box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:30;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:38px;height:38px;border-radius:14px;
      display:grid;place-items:center;
      background:
        radial-gradient(circle at 30% 30%, rgba(250,204,21,.35), transparent 55%),
        linear-gradient(135deg, rgba(34,197,94,.30), rgba(245,158,11,.25));
      border:1px solid rgba(255,255,255,.15);
      font-weight:900;
    }
    .brand .t1{margin:0;font-size:14px;font-weight:900;letter-spacing:.3px}
    .brand .t2{margin:2px 0 0;font-size:12px;color:rgba(234,255,241,.65)}

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(6,20,18,.55);
      cursor:pointer;
      font-size:12px;
      user-select:none;
      white-space:nowrap;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
    }
    .btn:active{transform:scale(.98)}
    .btn.primary{background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.22)}
    .btn.gold{background: rgba(250,204,21,.12); border-color: rgba(250,204,21,.22)}
    .btn.ghost{background: rgba(0,0,0,.20)}
    .btn.small{padding:8px 10px;font-size:12px}

    .hero{
      margin-top:14px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--r);
      background: rgba(11,42,31,.30);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .heroIn{padding:14px 14px 12px}
    .hTitle{font-weight:1000;font-size:18px;letter-spacing:.2px}
    .hSub{margin-top:6px;color:rgba(234,255,241,.70);font-size:13px;line-height:1.35}

    .controls{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1.3fr .9fr .9fr .9fr;
      gap:10px;
      align-items:center;
    }
    @media (max-width:980px){ .controls{grid-template-columns:1fr 1fr; } }
    @media (max-width:540px){ .controls{grid-template-columns:1fr; } }

    .field{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(6,20,18,.45);
      border-radius: 16px;
      padding:10px 10px;
      display:flex; align-items:center; gap:10px;
    }
    .field input, .field select{
      width:100%;
      background:transparent;
      border:0;
      outline:none;
      color:var(--text);
      font-size:13px;
      appearance:none;
    }
    .field label{font-size:12px;color:rgba(234,255,241,.65);white-space:nowrap}

    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.16);
      font-size:12px;
      color:rgba(234,255,241,.86);
      cursor:pointer;
      user-select:none;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
    }
    .chip:active{transform:scale(.98)}
    .chip.on{border-color: rgba(250,204,21,.32); background: rgba(250,204,21,.10);}

    .statsRow{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      margin-top:12px;
    }
    .stat{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.16);
      font-size:12px;
      color:rgba(234,255,241,.86);
    }

    /* ==========================
       GRID + NETFLIX CARDS V2
       ========================== */
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
    }
    @media (max-width:980px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width:560px){ .grid{grid-template-columns: 1fr;} }

    .card{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(11,42,31,.55);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow:hidden;
      transform: translateZ(0);
    }
    .card:hover{border-color: rgba(250,204,21,.16)}
    .cover{
      position:relative;
      height: 185px;
      background:
        radial-gradient(700px 260px at 20% 20%, rgba(250,204,21,.18), transparent 55%),
        radial-gradient(700px 260px at 80% 80%, rgba(34,197,94,.16), transparent 55%),
        linear-gradient(135deg, rgba(6,20,18,.55), rgba(0,0,0,.35));
      overflow:hidden;
    }
    .cover img{
      width:100%;
      height:100%;
      object-fit:cover;
      object-position:center;
      display:block;
      transform:scale(1.06);
      filter:saturate(1.05) contrast(1.05);
    }
    .cover::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(
        180deg,
        rgba(0,0,0,.05) 0%,
        rgba(0,0,0,.22) 45%,
        rgba(0,0,0,.78) 100%
      );
      pointer-events:none;
    }

    .topBadges{
      position:absolute;
      top:10px; left:10px; right:10px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      z-index:2;
    }
    .tagBadge{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      font-size:12px;
    }
    .dot{width:9px;height:9px;border-radius:999px;background:rgba(255,255,255,.35)}
    .open .dot{background:var(--green)}
    .boost .dot{background:var(--orange)}
    .closed .dot{background:var(--danger)}

    .bottomText{
      position:absolute;
      left:0; right:0; bottom:0;
      padding:12px 12px 12px;
      z-index:2;
    }
    .title{
      font-weight:1000;
      font-size:16px;
      line-height:1.15;
      text-shadow: 0 6px 18px rgba(0,0,0,.55);
    }
    .meta{
      margin-top:6px;
      color:rgba(234,255,241,.78);
      font-size:12px;
      line-height:1.25;
    }
    .pills{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .pill{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      font-size:12px;
      color:rgba(234,255,241,.90);
      backdrop-filter: blur(10px);
    }

    .cardIn{
      padding:12px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .desc{
      color:rgba(234,255,241,.72);
      font-size:13px;
      line-height:1.35;
    }
    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:2px;
    }

    .empty{
      margin-top:14px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius: var(--r);
      padding:16px;
      background: rgba(0,0,0,.18);
      color:rgba(234,255,241,.85);
      text-align:center;
      line-height:1.4;
    }

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:14px; z-index:80;
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(234,255,241,.92);
      padding:10px 12px;
      border-radius: 999px;
      backdrop-filter: blur(10px);
      display:none;
      max-width:min(94vw, 720px);
      box-shadow: var(--shadow);
      font-size:13px;
    }
    .toast.show{display:block}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">‚ôæÔ∏è</div>
        <div>
          <div class="t1">DIGIY EXPLORE</div>
          <div class="t2">Vitrine ‚Äî Spots publi√©s (V2)</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
        <a class="btn ghost" href="./explore.html">üß≠ Explorer</a>
        <a class="btn gold" href="./spot.html?slug=chez-astou-saly">‚≠ê Exemple</a>
      </div>
    </div>

    <div class="hero">
      <div class="heroIn">
        <div class="hTitle">Trouve un spot terrain en 2 secondes.</div>
        <div class="hSub">Contact direct. Infos utiles. Itin√©raire. Une vitrine simple, rapide, propre.</div>

        <div class="controls">
          <div class="field">
            <label>üîé</label>
            <input id="q" type="search" placeholder="Rechercher : Chez Astou, Saly, plage, tags‚Ä¶" autocomplete="off">
          </div>

          <div class="field">
            <label>Type</label>
            <select id="type">
              <option value="">Tous</option>
              <option value="resto">resto</option>
              <option value="plage">plage</option>
              <option value="culture">culture</option>
              <option value="nature">nature</option>
              <option value="hebergement">hebergement</option>
              <option value="activite">activite</option>
            </select>
          </div>

          <div class="field">
            <label>Budget</label>
            <select id="budget">
              <option value="">Tous</option>
              <option value="petit">petit</option>
              <option value="moyen">moyen</option>
              <option value="premium">premium</option>
            </select>
          </div>

          <div class="field">
            <label>Tri</label>
            <select id="sort">
              <option value="score_desc">Score ‚Üì</option>
              <option value="new_desc">Nouveau ‚Üì</option>
              <option value="az">A ‚Üí Z</option>
            </select>
          </div>
        </div>

        <div class="chips" id="quickChips"></div>

        <div class="statsRow">
          <div class="stat" id="statLine">Chargement‚Ä¶</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <div class="btn small ghost" id="btnReload">üîÑ Recharger</div>
            <div class="btn small gold" id="btnCopyUrl">üîó Copier lien filtre</div>
          </div>
        </div>
      </div>
    </div>

    <div id="grid" class="grid"></div>
    <div id="empty" class="empty" style="display:none"></div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ===============================
   SUPABASE (HARDCODED)
================================ */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

/* ===============================
   HELPERS
================================ */
const $ = (s)=>document.querySelector(s);
const toastEl = $("#toast");
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 2800);
}
function esc(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function normalizePhone(p){
  if(!p) return "";
  return (p+"").trim().replace(/[^\d+]/g,"");
}
function buildWhatsAppLink(phone, title){
  const p = normalizePhone(phone).replace(/\+/g,"");
  if(!p) return "";
  const txt = encodeURIComponent(`Bonjour üëã Je viens de voir "${title||"votre spot"}" sur DIGIY EXPLORE. Je veux des infos svp.`);
  return `https://wa.me/${p}?text=${txt}`;
}
function buildMapsLink(lat,lng,title){
  if(!isFinite(lat) || !isFinite(lng)) return "";
  const q = encodeURIComponent(`${lat},${lng} (${title||"Spot"})`);
  return `https://www.google.com/maps?q=${q}`;
}
function qs(k){ return new URL(location.href).searchParams.get(k); }
function setQs(params){
  const u = new URL(location.href);
  Object.entries(params).forEach(([k,v])=>{
    if(v===null || v===undefined || v==="") u.searchParams.delete(k);
    else u.searchParams.set(k, v);
  });
  history.replaceState({}, "", u.toString());
}
function getSb(){
  if(!window.supabase?.createClient) throw new Error("Supabase JS not loaded");
  return window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:false } });
}
const sb = getSb();

/* Placeholder SVG (fallback image if broken URL) */
const IMG_FALLBACK = `data:image/svg+xml;utf8,` + encodeURIComponent(`
<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="700">
  <defs>
    <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
      <stop offset="0" stop-color="#0b2a1f"/>
      <stop offset="1" stop-color="#020617"/>
    </linearGradient>
  </defs>
  <rect width="100%" height="100%" fill="url(#g)"/>
  <text x="50%" y="46%" text-anchor="middle" font-size="44" fill="#eafff1" font-family="Arial" font-weight="800">‚ôæÔ∏è DIGIY EXPLORE</text>
  <text x="50%" y="56%" text-anchor="middle" font-size="26" fill="rgba(234,255,241,.70)" font-family="Arial">Photo indisponible</text>
</svg>
`);

/* ===============================
   STATE
================================ */
let ALL = [];
let filtered = [];

const TYPES = ["resto","plage","culture","nature","hebergement","activite"];
const QUICK = [
  {k:"type", v:"resto", label:"üçΩÔ∏è Resto"},
  {k:"type", v:"plage", label:"üèñÔ∏è Plage"},
  {k:"type", v:"culture", label:"üèõÔ∏è Culture"},
  {k:"type", v:"nature", label:"üåø Nature"},
  {k:"type", v:"hebergement", label:"üè† H√©bergement"},
  {k:"type", v:"activite", label:"‚ö° Activit√©s"},
  {k:"budget", v:"petit", label:"üí∏ Petit"},
  {k:"budget", v:"moyen", label:"üí∞ Moyen"},
  {k:"budget", v:"premium", label:"üëë Premium"},
];

/* ===============================
   UI INIT
================================ */
function renderQuickChips(){
  const box = $("#quickChips");
  box.innerHTML = QUICK.map(c=>`<div class="chip" data-k="${c.k}" data-v="${c.v}">${esc(c.label)}</div>`).join("");
  box.querySelectorAll(".chip").forEach(ch=>{
    ch.onclick = ()=>{
      const k = ch.getAttribute("data-k");
      const v = ch.getAttribute("data-v");
      if(k==="type") $("#type").value = ($("#type").value===v ? "" : v);
      if(k==="budget") $("#budget").value = ($("#budget").value===v ? "" : v);
      applyFilters(true);
    };
  });
}

function readUrlFilters(){
  const q = (qs("q")||"").trim();
  const type = (qs("type")||"").trim();
  const budget = (qs("budget")||"").trim();
  const sort = (qs("sort")||"score_desc").trim();

  $("#q").value = q;
  $("#type").value = TYPES.includes(type) ? type : "";
  $("#budget").value = ["petit","moyen","premium"].includes(budget) ? budget : "";
  $("#sort").value = ["score_desc","new_desc","az"].includes(sort) ? sort : "score_desc";
}

function writeUrlFilters(){
  setQs({
    q: ($("#q").value||"").trim(),
    type: ($("#type").value||"").trim(),
    budget: ($("#budget").value||"").trim(),
    sort: ($("#sort").value||"").trim(),
  });
}

/* ===============================
   DATA LOAD
================================ */
async function loadSpots(){
  $("#statLine").textContent = "Chargement‚Ä¶";

  const { data, error } = await sb
    .from("digiy_explore_spots")
    .select("id, created_at, name, slug, type, zone, city, lat, lng, badge, description, photo_url, phone, link_url, status, duree, budget, tags, score")
    .eq("status","published")
    .limit(500);

  if(error){
    console.error("SUPABASE ERROR:", error);
    $("#grid").innerHTML = "";
    $("#empty").style.display = "block";
    $("#empty").innerHTML = `‚ùå Erreur lecture (RLS / table).<br><span style="opacity:.8">Ouvre Console (F12) pour voir le d√©tail.</span>`;
    $("#statLine").textContent = "Erreur";
    toast("Erreur lecture (Supabase/RLS)");
    return;
  }

  ALL = Array.isArray(data) ? data : [];
  applyFilters(false);
}

/* ===============================
   FILTER + SORT
================================ */
function spotText(s){
  const tags = Array.isArray(s.tags) ? s.tags.join(" ") : "";
  return `${s.name||""} ${s.type||""} ${s.zone||""} ${s.city||""} ${tags}`.toLowerCase();
}

function applyFilters(pushUrl){
  const q = ($("#q").value||"").trim().toLowerCase();
  const type = ($("#type").value||"").trim();
  const budget = ($("#budget").value||"").trim();
  const sort = ($("#sort").value||"score_desc").trim();

  if(pushUrl) writeUrlFilters();

  filtered = ALL.filter(s=>{
    if(type && (s.type||"") !== type) return false;
    if(budget && (s.budget||"") !== budget) return false;
    if(q){
      if(!spotText(s).includes(q)) return false;
    }
    return true;
  });

  if(sort==="az"){
    filtered.sort((a,b)=>String(a.name||"").localeCompare(String(b.name||""), "fr"));
  } else if(sort==="new_desc"){
    filtered.sort((a,b)=>new Date(b.created_at||0) - new Date(a.created_at||0));
  } else {
    filtered.sort((a,b)=> (Number(b.score)||0) - (Number(a.score)||0));
  }

    render();
  syncChips();
}

function syncChips(){
  const type = ($("#type").value||"").trim();
  const budget = ($("#budget").value||"").trim();
  document.querySelectorAll("#quickChips .chip").forEach(ch=>{
    const k = ch.getAttribute("data-k");
    const v = ch.getAttribute("data-v");
    const on = (k==="type" && v===type) || (k==="budget" && v===budget);
    ch.classList.toggle("on", on);
  });
}

/* ===============================
   RENDER GRID
================================ */
function badgeClass(b){
  b = (b||"").toString().toLowerCase().trim();
  if(["open","ouvert","üü¢"].includes(b)) return "open";
  if(["boost","boosted","üî•"].includes(b)) return "boost";
  if(["closed","ferme","üî¥"].includes(b)) return "closed";
  return "";
}
function badgeLabel(b){
  b = (b||"").toString().toLowerCase().trim();
  if(["open","ouvert","üü¢"].includes(b)) return "üü¢ Ouvert";
  if(["boost","boosted","üî•"].includes(b)) return "üî• Boost";
  if(["closed","ferme","üî¥"].includes(b)) return "üî¥ Ferm√©";
  return "‚ú® Spot";
}
function cleanDesc(s){
  const t = (s||"").toString().trim();
  if(!t) return "Infos simples, contact direct, spot terrain DIGIY.";
  return t.length > 120 ? (t.slice(0,117) + "‚Ä¶") : t;
}
function pickCover(s){
  const u = (s?.photo_url || "").toString().trim();
  return u || IMG_FALLBACK;
}

function render(){
  const grid = $("#grid");
  const empty = $("#empty");

  $("#statLine").textContent = `${filtered.length} spot(s) ‚Ä¢ Public`;

  if(filtered.length === 0){
    grid.innerHTML = "";
    empty.style.display = "block";
    empty.innerHTML = `Aucun spot trouv√© üòÖ<br><span style="opacity:.85">Change les filtres ou tape un autre mot.</span>`;
    return;
  }
  empty.style.display = "none";

  grid.innerHTML = filtered.map(s=>{
    const title = s.name || "Spot";
    const slug = s.slug || "";
    const href = slug ? `./spot.html?slug=${encodeURIComponent(slug)}` : (s.id ? `./spot.html?id=${encodeURIComponent(s.id)}` : "#");
    const bcls = badgeClass(s.badge);
    const blab = badgeLabel(s.badge);

    const meta = `üìç ${[s.zone, s.city].filter(Boolean).join(" ‚Ä¢ ") || "‚Äî"}`;
    const pills = [
      s.type ? `üè∑Ô∏è ${s.type}` : "",
      s.budget ? `üí∞ ${s.budget}` : "",
      s.duree ? `‚è±Ô∏è ${s.duree}` : "",
    ].filter(Boolean);

    const wa = buildWhatsAppLink(s.phone, title);
    const maps = buildMapsLink(Number(s.lat), Number(s.lng), title);

    const cover = pickCover(s);

    return `
      <div class="card">
        <div class="cover">
          <img src="${esc(cover)}" alt="" loading="lazy"
               onerror="this.onerror=null; this.src='${esc(IMG_FALLBACK)}';" />
          <div class="topBadges">
            <div class="tagBadge ${esc(bcls)}"><span class="dot"></span> ${esc(blab)}</div>
          </div>
          <div class="bottomText">
            <a class="title" href="${esc(href)}">${esc(title)}</a>
            <div class="meta">${esc(meta)}</div>
            <div class="pills">
              ${pills.map(p=>`<span class="pill">${esc(p)}</span>`).join("")}
            </div>
          </div>
        </div>

        <div class="cardIn">
          <div class="desc">${esc(cleanDesc(s.description))}</div>

          <div class="actions">
            <a class="btn small gold" href="${esc(href)}">üëÄ Voir</a>
            ${wa ? `<a class="btn small primary" href="${esc(wa)}" target="_blank" rel="noopener noreferrer">üí¨ WhatsApp</a>` : ``}
            ${maps ? `<a class="btn small ghost" href="${esc(maps)}" target="_blank" rel="noopener noreferrer">üó∫Ô∏è Itin√©raire</a>` : ``}
          </div>
        </div>
      </div>
    `;
  }).join("");
}

/* ===============================
   EVENTS
================================ */
function bindEvents(){
  $("#q").addEventListener("input", ()=>applyFilters(true));
  $("#type").addEventListener("change", ()=>applyFilters(true));
  $("#budget").addEventListener("change", ()=>applyFilters(true));
  $("#sort").addEventListener("change", ()=>applyFilters(true));

  $("#btnReload").onclick = ()=>loadSpots();

  $("#btnCopyUrl").onclick = async ()=>{
    const url = location.href;
    try{
      await navigator.clipboard.writeText(url);
      toast("‚úÖ Lien copi√©.");
    }catch(e){
      toast("Copie impossible (s√©curit√© navigateur).");
    }
  };
}

/* ===============================
   BOOT
================================ */
(function boot(){
  try{
    renderQuickChips();
    readUrlFilters();
    bindEvents();
    loadSpots();
  }catch(err){
    console.error("BOOT ERROR:", err);
    $("#grid").innerHTML = "";
    $("#empty").style.display = "block";
    $("#empty").innerHTML = `Crash JS üòµ‚Äçüí´<br><span style="opacity:.85">Ouvre Console (F12) pour voir l‚Äôerreur.</span>`;
    $("#statLine").textContent = "Crash";
    toast("Crash JS ‚Äî Console");
  }
})();
</script>
</body>
</html>

