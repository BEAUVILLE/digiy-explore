<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#071a13" />
  <title>DIGIY EXPLORE ‚Äî Public (Boost Clean V2)</title>
  <meta name="description" content="DIGIY EXPLORE ‚Äî D√©couvre autour de toi (0% commission). Spots, services, restos, logements." />

  <!-- Leaflet (carte) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#071a13;
      --bg2:#061412;
      --card:#0b2a1f;
      --card2:#0a241b;
      --line:rgba(255,255,255,.12);
      --text:#eafff1;
      --muted:rgba(234,255,241,.72);
      --gold:#facc15;
      --orange:#f59e0b;
      --green:#22c55e;
      --danger:#fb7185;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --r:18px;
      --r2:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(900px 480px at 12% 10%, rgba(250,204,21,.12), transparent 60%),
        radial-gradient(900px 480px at 88% 90%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, #020617 100%);
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{
      max-width:1180px;
      margin:0 auto;
      padding:16px 14px 28px;
    }

    /* Header */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border:1px solid var(--line);
      background:rgba(11,42,31,.65);
      backdrop-filter: blur(10px);
      border-radius:22px;
      box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:30;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 220px;
    }
    .logo{
      width:38px;height:38px;border-radius:14px;
      display:grid;place-items:center;
      background:
        radial-gradient(circle at 30% 30%, rgba(250,204,21,.35), transparent 55%),
        linear-gradient(135deg, rgba(34,197,94,.30), rgba(245,158,11,.25));
      border:1px solid rgba(255,255,255,.15);
      font-weight:900;
    }
    .brand h1{
      margin:0;
      font-size:14px;
      line-height:1.1;
      letter-spacing:.3px;
    }
    .brand .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .actions{
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:9px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(6,20,18,.55);
      color:var(--text);
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
    }
    .pill:active{transform: scale(.98)}
    .pill.on{
      border-color: rgba(250,204,21,.55);
      background: rgba(250,204,21,.12);
    }
    .pill .dot{
      width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.35);
    }
    .pill.on .dot{background: var(--gold)}
    .pill.warn.on{border-color: rgba(245,158,11,.65); background: rgba(245,158,11,.12)}
    .pill.warn.on .dot{background: var(--orange)}
    .pill.good.on{border-color: rgba(34,197,94,.65); background: rgba(34,197,94,.10)}
    .pill.good.on .dot{background: var(--green)}
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(34,197,94,.12);
      cursor:pointer;
      font-size:12px;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      white-space:nowrap;
    }
    .btn:hover{border-color: rgba(34,197,94,.45)}
    .btn:active{transform: scale(.98)}
    .btn.secondary{
      background: rgba(250,204,21,.10);
      border-color: rgba(250,204,21,.22);
    }

    /* Layout */
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr; }
      .brand{min-width:auto}
    }

    /* Search bar */
    .panel{
      border:1px solid var(--line);
      background: rgba(11,42,31,.55);
      backdrop-filter: blur(10px);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-hd{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .panel-hd .title{
      font-weight:800;
      font-size:13px;
      letter-spacing:.2px;
    }
    .panel-hd .meta{
      font-size:12px;color:var(--muted);
    }
    .searchRow{
      padding:10px 12px 12px;
      display:grid;
      grid-template-columns: 1fr 140px;
      gap:10px;
    }
    @media (max-width:560px){
      .searchRow{grid-template-columns:1fr}
    }
    .input{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(6,20,18,.55);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    .select{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(6,20,18,.55);
      color:var(--text);
      outline:none;
      font-size:14px;
      appearance:none;
    }

    /* Chips categories */
    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding:0 12px 12px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(6,20,18,.45);
      cursor:pointer;
      font-size:12px;
      color:rgba(234,255,241,.92);
      transition: background .15s ease, border-color .15s ease, transform .05s ease;
      user-select:none;
    }
    .chip:active{transform:scale(.98)}
    .chip.on{
      border-color: rgba(250,204,21,.55);
      background: rgba(250,204,21,.12);
    }
    .chip .k{
      width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.35);
    }
    .chip.on .k{background: var(--gold)}

    /* List */
    .list{
      padding: 12px;
      display:grid;
      gap:10px;
    }
    .card{
      border:1px solid rgba(255,255,255,.12);
      border-radius: var(--r2);
      background: rgba(6,20,18,.45);
      overflow:hidden;
      display:grid;
      grid-template-columns: 110px 1fr;
      gap:0;
      cursor:pointer;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
    }
    .card:hover{
      border-color: rgba(250,204,21,.25);
      background: rgba(6,20,18,.55);
    }
    .card:active{transform: scale(.995)}
    .thumb{
      height:100%;
      min-height:92px;
      background:
        radial-gradient(circle at 30% 30%, rgba(250,204,21,.22), transparent 55%),
        radial-gradient(circle at 70% 70%, rgba(34,197,94,.16), transparent 55%),
        linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-right:1px solid rgba(255,255,255,.08);
      position:relative;
      overflow:hidden;
    }
    .thumb img{
      width:100%;height:100%;
      object-fit:cover;
      display:block;
      filter:saturate(1.05);
    }
    .badge{
      position:absolute;left:8px;top:8px;
      font-size:11px;
      padding:6px 8px;
      border-radius:999px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.18);
      display:inline-flex; align-items:center; gap:6px;
      backdrop-filter: blur(8px);
    }
    .badge .b{width:8px;height:8px;border-radius:999px;background: rgba(255,255,255,.35)}
    .badge.boost .b{background: var(--orange)}
    .badge.open .b{background: var(--green)}
    .badge.closed .b{background: var(--danger)}
    .cardBody{padding:10px 10px 10px}
    .row1{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .name{font-weight:900; font-size:14px; line-height:1.15}
    .cat{font-size:12px; color:var(--muted); margin-top:4px}
    .row2{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-top:8px;
      font-size:12px;
      color:rgba(234,255,241,.85);
    }
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }
    .tag .t{width:7px;height:7px;border-radius:999px;background: rgba(255,255,255,.28)}
    .tag.good .t{background: var(--green)}
    .tag.warn .t{background: var(--orange)}

    /* Map */
    #map{
      width:100%;
      height: 520px;
      border-radius: var(--r);
      overflow:hidden;
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      background: rgba(11,42,31,.55);
    }
    @media (max-width: 980px){
      #map{height: 420px}
    }
    .mapWrap{
      position:sticky; top:86px;
    }
    @media (max-width: 980px){
      .mapWrap{position:static}
    }

    /* Empty / loading */
    .state{
      padding:18px 12px;
      color:var(--muted);
      font-size:13px;
      text-align:center;
    }
    .hr{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
    .small{font-size:12px;color:var(--muted)}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:14px; z-index:80;
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(234,255,241,.92);
      padding:10px 12px;
      border-radius: 999px;
      backdrop-filter: blur(10px);
      display:none;
      max-width:min(94vw, 720px);
      box-shadow: var(--shadow);
      font-size:13px;
    }
    .toast.show{display:block}
  </style>
</head>

<body>
  <div class="wrap">

    <!-- TOPBAR -->
    <div class="topbar">
      <div class="brand" role="banner">
        <div class="logo">‚ôæÔ∏è</div>
        <div>
          <h1>DIGIY EXPLORE</h1>
          <div class="sub">Boost Clean V2 ‚Äî D√©couvre comme un local</div>
        </div>
      </div>

      <div class="actions">
        <div id="pillNear" class="pill good" title="Trouver autour de moi">
          <span class="dot"></span> Autour de moi
        </div>
        <div id="pillBoost" class="pill warn" title="Afficher d‚Äôabord les spots boost√©s">
          <span class="dot"></span> Top Boost
        </div>
        <div id="pillOpenNow" class="pill" title="Filtrer : ouvert maintenant (si horaires fournis)">
          <span class="dot"></span> Ouvert
        </div>
        <div id="btnReload" class="btn secondary">üîÑ Rafra√Æchir</div>
        <div id="btnHelp" class="btn">üß≠ Aide</div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: LIST + FILTERS -->
      <div class="panel">
        <div class="panel-hd">
          <div>
            <div class="title">Explorer</div>
            <div class="meta" id="metaLine">Chargement‚Ä¶</div>
          </div>
          <div class="small" id="locLine">üìç Position : ‚Äî</div>
        </div>

        <div class="searchRow">
          <input id="q" class="input" placeholder="Recherche : resto, logement, artisan‚Ä¶ (ex: 'poisson', 'coiffeur', 'Saly')" />
          <select id="city" class="select">
            <option value="">Ville (toutes)</option>
          </select>
        </div>

        <div class="chips" id="chips"></div>

        <div class="hr"></div>

        <div class="list" id="list">
          <div class="state">Chargement des spots‚Ä¶</div>
        </div>
      </div>

      <!-- RIGHT: MAP -->
      <div class="mapWrap">
        <div id="map"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* =========================================================
   DIGIY EXPLORE ‚Äî BOOST CLEAN V2 (1) ‚Äî PUBLIC INDEX
   - Carte + liste + filtres + "autour de moi" + tri boost
   - Table attendue: public.digiy_explore_spots
     Champs recommand√©s:
      id, slug, title, category, city, phone,
      lat, lng, photos (text[]), status,
      boost_rank (int) OU is_boosted (bool) OU boost_until (timestamptz),
      open_hours_json (jsonb optionnel)
   ========================================================= */

/* -------------------------
   Supabase config
   ------------------------- */
const DEFAULT_SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";

/* üí° Fr√©rot: pour √©viter de recoller la cl√© partout,
   tu peux la stocker une fois:
   localStorage.setItem("DIGIY_SUPABASE_ANON", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";)
*/
const DEFAULT_SUPABASE_ANON =
  (localStorage.getItem("DIGIY_SUPABASE_ANON") || "").trim();

/* Option: config globale si tu veux
   window.__DIGIY_SUPABASE__ = { url:"...", anon:"..." }
*/
const CFG = window.__DIGIY_SUPABASE__ || {};
const SUPABASE_URL = (CFG.url || DEFAULT_SUPABASE_URL).trim();
const SUPABASE_ANON_KEY = (CFG.anon || DEFAULT_SUPABASE_ANON_KEY_FALLBACK()).trim();

function DEFAULT_SUPABASE_ANON_KEY_FALLBACK(){
  // Si vide, on laisse vide et on explique via toast.
  return DEFAULT_SUPABASE_ANON || "";
}

let sb = null;

function ensureSupabase(){
  if(sb) return sb;
  if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
    toast("‚ö†Ô∏è Cl√© Supabase manquante. Mets ton ANON dans localStorage: DIGIY_SUPABASE_ANON");
    throw new Error("Supabase config missing (anon).");
  }
  sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession:false }
  });
  return sb;
}

/* -------------------------
   UI helpers
   ------------------------- */
const $ = (s)=>document.querySelector(s);
const listEl = $("#list");
const chipsEl = $("#chips");
const metaLine = $("#metaLine");
const locLine = $("#locLine");
const toastEl = $("#toast");

function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 2800);
}

function esc(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

/* -------------------------
   State
   ------------------------- */
const CATEGORIES = [
  {key:"manger", label:"üç≤ Manger"},
  {key:"dormir", label:"üè† Dormir"},
  {key:"acheter", label:"üõçÔ∏è Acheter"},
  {key:"transport", label:"üöï Transport"},
  {key:"services", label:"üõ†Ô∏è Services"},
  {key:"spots", label:"üèñÔ∏è Spots"},
];

let rawSpots = [];
let filteredSpots = [];
let markers = [];
let userPos = null;

let filters = {
  q: "",
  city: "",
  category: "",
  near: false,
  topBoost: false,
  openNow: false,
};

const NEAR_RADIUS_KM = 4.0;

/* -------------------------
   Map init
   ------------------------- */
const DEFAULT_CENTER = [14.446, -17.007]; // proche Saly/Mbour (ajuste si tu veux)
const DEFAULT_ZOOM = 11;

const map = L.map("map", { zoomControl:true }).setView(DEFAULT_CENTER, DEFAULT_ZOOM);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution: "&copy; OpenStreetMap"
}).addTo(map);

const userMarker = L.circleMarker(DEFAULT_CENTER, {
  radius:8, weight:2, fillOpacity:.4
});
let userMarkerAdded = false;

/* -------------------------
   Chips render
   ------------------------- */
function renderChips(){
  const html = [
    `<div class="chip ${filters.category===""?"on":""}" data-cat="">
      <span class="k"></span> Tout
    </div>`,
    ...CATEGORIES.map(c => `
      <div class="chip ${filters.category===c.key?"on":""}" data-cat="${esc(c.key)}">
        <span class="k"></span> ${esc(c.label)}
      </div>
    `)
  ].join("");
  chipsEl.innerHTML = html;

  chipsEl.querySelectorAll(".chip").forEach(ch=>{
    ch.addEventListener("click", ()=>{
      filters.category = ch.getAttribute("data-cat") || "";
      renderChips();
      applyFilters();
    });
  });
}

/* -------------------------
   Distance (km)
   ------------------------- */
function haversineKm(lat1,lng1,lat2,lng2){
  const R = 6371;
  const toRad = d => d * Math.PI / 180;
  const dLat = toRad(lat2-lat1);
  const dLng = toRad(lng2-lng1);
  const a = Math.sin(dLat/2)**2 +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
            Math.sin(dLng/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}

/* -------------------------
   Open now (optionnel)
   - si spot.open_hours_json = { "mon":[["09:00","18:00"]], ... }
   ------------------------- */
function isOpenNow(spot){
  const oh = spot?.open_hours_json;
  if(!oh || typeof oh !== "object") return null; // inconnu
  const d = new Date();
  const dayKey = ["sun","mon","tue","wed","thu","fri","sat"][d.getDay()];
  const slots = oh[dayKey];
  if(!Array.isArray(slots)) return null;

  const nowMin = d.getHours()*60 + d.getMinutes();
  for(const s of slots){
    if(!Array.isArray(s) || s.length<2) continue;
    const [a,b] = s;
    const am = parseTimeToMin(a);
    const bm = parseTimeToMin(b);
    if(am==null || bm==null) continue;
    if(nowMin >= am && nowMin <= bm) return true;
  }
  return false;
}
function parseTimeToMin(t){
  if(typeof t !== "string") return null;
  const m = t.trim().match(/^(\d{1,2}):(\d{2})$/);
  if(!m) return null;
  const hh = Math.max(0, Math.min(23, parseInt(m[1],10)));
  const mm = Math.max(0, Math.min(59, parseInt(m[2],10)));
  return hh*60+mm;
}

/* -------------------------
   Markers
   ------------------------- */
function clearMarkers(){
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}
function fitToSpots(spots){
  const pts = spots
    .filter(s => isFinite(s.lat) && isFinite(s.lng))
    .map(s => [Number(s.lat), Number(s.lng)]);
  if(pts.length === 0){
    map.setView(DEFAULT_CENTER, DEFAULT_ZOOM);
    return;
  }
  const b = L.latLngBounds(pts);
  map.fitBounds(b.pad(0.18));
}

function addMarkers(spots){
  clearMarkers();
  for(const s of spots){
    if(!isFinite(s.lat) || !isFinite(s.lng)) continue;
    const open = isOpenNow(s);
    const badge = s._boosted ? "üî• Boost" : (open===true ? "üü¢ Ouvert" : (open===false ? "üî¥ Ferm√©" : "üìç Spot"));
    const m = L.marker([Number(s.lat), Number(s.lng)]);
    m.addTo(map);
    m.bindPopup(`
      <div style="min-width:220px">
        <div style="font-weight:900;margin-bottom:4px">${esc(s.title || "Spot")}</div>
        <div style="opacity:.8;font-size:12px;margin-bottom:8px">${esc(s.category || "‚Äî")} ‚Ä¢ ${esc(s.city || "‚Äî")}</div>
        <div style="font-size:12px;margin-bottom:10px">${esc(badge)}</div>
        <button
          style="width:100%;padding:10px 10px;border-radius:12px;border:1px solid rgba(0,0,0,.12);background:#facc15;font-weight:900;cursor:pointer"
          onclick="location.href='./spot.html?slug=${encodeURIComponent(s.slug||"")}'"
        >Voir la fiche</button>
      </div>
    `);
    markers.push(m);
  }
}

/* -------------------------
   List render
   ------------------------- */
function pickPhoto(spot){
  const arr = spot?.photos;
  if(Array.isArray(arr) && arr.length){
    const u = (arr[0] || "").toString().trim();
    return u || "";
  }
  // fallback possible: spot.photo_url
  const u2 = (spot?.photo_url || "").toString().trim();
  return u2 || "";
}

function renderList(spots){
  if(!spots.length){
    listEl.innerHTML = `<div class="state">Aucun spot trouv√©. Essaie une autre recherche, ou enl√®ve un filtre.</div>`;
    return;
  }

  const html = spots.map(s=>{
    const img = pickPhoto(s);
    const open = isOpenNow(s);
    const dist = (filters.near && userPos && isFinite(s.lat) && isFinite(s.lng))
      ? haversineKm(userPos.lat, userPos.lng, Number(s.lat), Number(s.lng))
      : null;

    const badgeClass = s._boosted ? "boost" : (open===true ? "open" : (open===false ? "closed" : ""));
    const badgeLabel = s._boosted ? "üî• Boost" : (open===true ? "üü¢ Ouvert" : (open===false ? "üî¥ Ferm√©" : "üìç Spot"));

    return `
      <div class="card" data-slug="${esc(s.slug||"")}">
        <div class="thumb">
          ${img ? `<img src="${esc(img)}" alt="">` : ``}
          <div class="badge ${badgeClass}">
            <span class="b"></span> ${esc(badgeLabel)}
          </div>
        </div>
        <div class="cardBody">
          <div class="row1">
            <div>
              <div class="name">${esc(s.title || "Spot")}</div>
              <div class="cat">${esc(s.category || "‚Äî")} ‚Ä¢ ${esc(s.city || "‚Äî")}</div>
            </div>
          </div>
          <div class="row2">
            ${dist!=null ? `<span class="tag good"><span class="t"></span> ${dist.toFixed(1)} km</span>` : ``}
            ${s.phone ? `<span class="tag"><span class="t"></span> üìû ${esc(s.phone)}</span>` : ``}
            ${s._boosted ? `<span class="tag warn"><span class="t"></span> Top</span>` : ``}
          </div>
        </div>
      </div>
    `;
  }).join("");

  listEl.innerHTML = html;

  listEl.querySelectorAll(".card").forEach(card=>{
    card.addEventListener("click", ()=>{
      const slug = card.getAttribute("data-slug") || "";
      if(!slug){ toast("Slug manquant sur ce spot."); return; }
      location.href = "./spot.html?slug=" + encodeURIComponent(slug);
    });
  });
}

/* -------------------------
   Filters + sorting
   ------------------------- */
function normalize(s){
  return (s||"").toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}

function computeBoosted(spot){
  // Tu peux piloter √ßa comme tu veux (3 options)
  // 1) spot.is_boosted bool
  if(spot?.is_boosted === true) return true;

  // 2) spot.boost_until (date)
  if(spot?.boost_until){
    const t = Date.parse(spot.boost_until);
    if(!Number.isNaN(t) && t > Date.now()) return true;
  }

  // 3) spot.boost_rank (int)
  if(Number.isFinite(spot?.boost_rank) && Number(spot.boost_rank) > 0) return true;

  return false;
}

function applyFilters(){
  const qn = normalize(filters.q);
  const cityN = normalize(filters.city);
  const catN = normalize(filters.category);

  let out = rawSpots.map(s=>{
    const boosted = computeBoosted(s);
    return Object.assign({}, s, { _boosted: boosted });
  });

  if(qn){
    out = out.filter(s=>{
      const t = normalize(s.title);
      const c = normalize(s.category);
      const city = normalize(s.city);
      const slug = normalize(s.slug);
      return (t.includes(qn) || c.includes(qn) || city.includes(qn) || slug.includes(qn));
    });
  }

  if(cityN){
    out = out.filter(s => normalize(s.city) === cityN);
  }

  if(catN){
    out = out.filter(s => normalize(s.category) === catN);
  }

  if(filters.openNow){
    out = out.filter(s => isOpenNow(s) === true);
  }

  if(filters.near){
    if(!userPos){
      toast("üìç Active la g√©olocalisation pour 'Autour de moi'.");
    } else {
      out = out
        .map(s=>{
          if(!isFinite(s.lat) || !isFinite(s.lng)) return Object.assign({}, s, {_dist: Infinity});
          const d = haversineKm(userPos.lat, userPos.lng, Number(s.lat), Number(s.lng));
          return Object.assign({}, s, { _dist: d });
        })
        .filter(s => s._dist <= NEAR_RADIUS_KM);
      out.sort((a,b)=> (a._dist||999) - (b._dist||999));
    }
  }

  // Top boost: d‚Äôabord boost, puis titre
  if(filters.topBoost){
    out.sort((a,b)=>{
      const A = a._boosted ? 1 : 0;
      const B = b._boosted ? 1 : 0;
      if(B !== A) return B - A;
      const ar = (a.boost_rank||0), br = (b.boost_rank||0);
      if(br !== ar) return br - ar;
      return (a.title||"").localeCompare(b.title||"", "fr");
    });
  } else {
    out.sort((a,b)=> (a.title||"").localeCompare(b.title||"", "fr"));
  }

  filteredSpots = out;

  metaLine.textContent = `${filteredSpots.length} spot(s) ‚Ä¢ filtre actif: ${
    [filters.category && ("cat:"+filters.category), filters.city && ("ville:"+filters.city), filters.near && ("pr√®s"), filters.topBoost && ("boost"), filters.openNow && ("ouvert")]
      .filter(Boolean).join(" / ") || "aucun"
  }`;

  renderList(filteredSpots);
  addMarkers(filteredSpots);
  if(!filters.near) fitToSpots(filteredSpots);
}

/* -------------------------
   City select fill
   ------------------------- */
function fillCities(spots){
  const cities = Array.from(new Set(spots.map(s => (s.city||"").trim()).filter(Boolean)))
    .sort((a,b)=>a.localeCompare(b,"fr"));
  const sel = $("#city");
  sel.innerHTML = `<option value="">Ville (toutes)</option>` + cities.map(c=>`<option value="${esc(c)}">${esc(c)}</option>`).join("");
}

/* -------------------------
   Load from Supabase
   ------------------------- */
async function loadSpots(){
  listEl.innerHTML = `<div class="state">Chargement des spots‚Ä¶</div>`;
  metaLine.textContent = "Chargement‚Ä¶";

  const sb = ensureSupabase();

  // ‚ö†Ô∏è S√©lection: adapte si tes colonnes diff√®rent
  const { data, error } = await sb
    .from("digiy_explore_spots")
    .select("id, slug, title, category, city, phone, lat, lng, photos, photo_url, status, is_boosted, boost_rank, boost_until, open_hours_json")
    .eq("status", "active")
    .limit(400);

  if(error){
    console.error(error);
    listEl.innerHTML = `<div class="state">Erreur chargement. V√©rifie Supabase / RLS / table digiy_explore_spots.</div>`;
    metaLine.textContent = "Erreur.";
    toast("‚ùå Supabase: erreur de lecture (RLS/table).");
    return;
  }

  rawSpots = (data || []).map(s=>{
    // s√©curit√© types
    if(s.lat!=null) s.lat = Number(s.lat);
    if(s.lng!=null) s.lng = Number(s.lng);
    return s;
  });

  fillCities(rawSpots);
  applyFilters();
}

/* -------------------------
   Geolocation
   ------------------------- */
async function getUserPos(){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation){
      reject(new Error("Geolocation not supported"));
      return;
    }
    navigator.geolocation.getCurrentPosition(
      (p)=> resolve({ lat:p.coords.latitude, lng:p.coords.longitude, acc:p.coords.accuracy }),
      (e)=> reject(e),
      { enableHighAccuracy:true, timeout: 9000, maximumAge: 90000 }
    );
  });
}

async function toggleNear(){
  filters.near = !filters.near;
  $("#pillNear").classList.toggle("on", filters.near);

  if(filters.near && !userPos){
    try{
      toast("üìç Localisation‚Ä¶");
      const p = await getUserPos();
      userPos = { lat:p.lat, lng:p.lng, acc:p.acc };
      locLine.textContent = `üìç Position : ${userPos.lat.toFixed(4)}, ${userPos.lng.toFixed(4)} (¬±${Math.round(userPos.acc)}m)`;

      // user marker
      if(!userMarkerAdded){
        userMarker.addTo(map);
        userMarkerAdded = true;
      }
      userMarker.setLatLng([userPos.lat, userPos.lng]);
      map.setView([userPos.lat, userPos.lng], 14);

    } catch(err){
      console.warn(err);
      filters.near = false;
      $("#pillNear").classList.remove("on");
      toast("‚ö†Ô∏è Autorise la localisation (sinon d√©sactive 'Autour de moi').");
    }
  }

  applyFilters();
}

/* -------------------------
   Events
   ------------------------- */
function bindUI(){
  renderChips();

  $("#q").addEventListener("input", (e)=>{
    filters.q = e.target.value || "";
    applyFilters();
  });

  $("#city").addEventListener("change", (e)=>{
    filters.city = e.target.value || "";
    applyFilters();
  });

  $("#pillNear").addEventListener("click", toggleNear);

  $("#pillBoost").addEventListener("click", ()=>{
    filters.topBoost = !filters.topBoost;
    $("#pillBoost").classList.toggle("on", filters.topBoost);
    applyFilters();
  });

  $("#pillOpenNow").addEventListener("click", ()=>{
    filters.openNow = !filters.openNow;
    $("#pillOpenNow").classList.toggle("on", filters.openNow);
    applyFilters();
  });

  $("#btnReload").addEventListener("click", ()=>{
    toast("üîÑ Rafra√Æchissement‚Ä¶");
    loadSpots();
  });

  $("#btnHelp").addEventListener("click", ()=>{
    toast("üß≠ Recherche + filtres + carte. Clique un spot ‚Üí fiche.");
  });
}

/* -------------------------
   Boot
   ------------------------- */
(function boot(){
  try{
    bindUI();
    loadSpots();
    // petits toggles visuels init
    $("#pillNear").classList.toggle("on", filters.near);
    $("#pillBoost").classList.toggle("on", filters.topBoost);
    $("#pillOpenNow").classList.toggle("on", filters.openNow);
  } catch(err){
    console.error(err);
    listEl.innerHTML = `<div class="state">Impossible de d√©marrer. V√©rifie la config Supabase (ANON).</div>`;
  }
})();
</script>
</body>
</html>
