<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <title>DIGIY EXPLORE V2 â€” Carte SÃ©nÃ©gal</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#0b2a1f"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body{margin:0;font-family:system-ui;background:#061b14;color:white}
    header{padding:14px;font-weight:900;font-size:18px}
    #map{height:75vh;border-top:1px solid rgba(255,255,255,.15)}
    .bar{
      padding:12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      background:#0b2a1f;
    }
    select,input{
      padding:10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.2);
      background:#061b14;
      color:white;
      font-weight:700;
    }
    a.btn{
      padding:10px 14px;
      border-radius:999px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#022c22;
      text-decoration:none;
      font-weight:900;
    }
  </style>
</head>

<body>
<header>DIGIY EXPLORE V2 ğŸ§­ğŸ‡¸ğŸ‡³</header>

<div class="bar">
  <input id="q" placeholder="Recherche spotâ€¦"/>
  <select id="type">
    <option value="all">âœ¨ Tous</option>
    <option value="resto">ğŸ² Resto</option>
    <option value="plage">ğŸ– Plage</option>
    <option value="culture">ğŸ­ Culture</option>
    <option value="nature">ğŸŒ¿ Nature</option>
    <option value="hebergement">ğŸ  HÃ©bergement</option>
    <option value="activite">ğŸ ActivitÃ©</option>
  </select>

  <a class="btn" href="./submit.html">â• Proposer un spot</a>
</div>

<div id="map"></div>

<script>
/* ===============================
   CONFIG SUPABASE
   =============================== */
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY = "âœ…TON_ANON_KEY_ICI";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const WA = "221771342889";

/* ===============================
   MAP INIT
   =============================== */
const map = L.map("map").setView([14.68,-17.45], 7);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  attribution:"Â© OpenStreetMap"
}).addTo(map);

let markers=[];

/* ===============================
   Load Spots Published
   =============================== */
async function loadSpots(){
  const { data, error } = await sb
    .from("digiy_explore_spots")
    .select("*")
    .eq("status","published");

  if(error){
    alert("Erreur chargement spots");
    console.error(error);
    return [];
  }
  return data||[];
}

function clearMarkers(){
  markers.forEach(m=>map.removeLayer(m));
  markers=[];
}

function render(spots){
  clearMarkers();

  const q = document.getElementById("q").value.toLowerCase();
  const type = document.getElementById("type").value;

  const filtered = spots.filter(s=>{
    const okType = (type==="all") ? true : s.type===type;
    const hay = (s.name+" "+(s.city||"")+" "+(s.description||"")).toLowerCase();
    const okQ = q ? hay.includes(q) : true;
    return okType && okQ;
  });

  filtered.forEach(s=>{
    if(!s.lat || !s.lng) return;

    const mk = L.marker([s.lat,s.lng]).addTo(map)
      .bindPopup(`
        <b>${s.name}</b><br>
        ${s.city||""}<br><br>
        <a target="_blank"
           href="https://wa.me/${WA}?text=${encodeURIComponent("Salut DIGIY ğŸ‘‹ je veux ce spot : "+s.name)}">
           ğŸ’¬ WhatsApp DIGIY
        </a><br>
        <a target="_blank"
           href="https://www.google.com/maps/search/?api=1&query=${s.lat},${s.lng}">
           ğŸ“ Ouvrir Maps
        </a>
      `);

    markers.push(mk);
  });
}

/* ===============================
   Init
   =============================== */
let ALL=[];

(async ()=>{
  ALL = await loadSpots();
  render(ALL);
})();

document.getElementById("q").addEventListener("input",()=>render(ALL));
document.getElementById("type").addEventListener("change",()=>render(ALL));
</script>

</body>
</html>
