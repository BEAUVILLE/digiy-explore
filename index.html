<!-- ======================================================
     DIGIY EXPLORE ‚Äî FULL PATCH (SPOT) ‚Äî ID MODE
     Fichier: spot.html
     URL: spot.html?id=<uuid>
====================================================== -->
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#071a13" />
  <title>DIGIY EXPLORE ‚Äî Fiche Spot (ID MODE)</title>
  <meta name="description" content="Fiche spot DIGIY EXPLORE (WhatsApp, localisation, paiement direct)." />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#071a13; --card:#0b2a1f; --card2:#0a241b;
      --line:rgba(255,255,255,.12);
      --text:#eafff1; --muted:rgba(234,255,241,.72);
      --gold:#facc15; --orange:#f59e0b; --green:#22c55e; --danger:#fb7185;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --r:18px; --r2:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 480px at 12% 10%, rgba(250,204,21,.12), transparent 60%),
        radial-gradient(900px 480px at 88% 90%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, #020617 100%);
      overflow-x:hidden;
    }
    .wrap{max-width:1080px;margin:0 auto;padding:16px 14px 34px}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      padding:10px 12px;
      border:1px solid var(--line);
      background:rgba(11,42,31,.65);
      backdrop-filter: blur(10px);
      border-radius:22px;
      box-shadow: var(--shadow);
      position:sticky; top:10px; z-index:30;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:38px;height:38px;border-radius:14px;
      display:grid;place-items:center;
      background:
        radial-gradient(circle at 30% 30%, rgba(250,204,21,.35), transparent 55%),
        linear-gradient(135deg, rgba(34,197,94,.30), rgba(245,158,11,.25));
      border:1px solid rgba(255,255,255,.15);
      font-weight:900;
    }
    .brand .t1{margin:0;font-size:14px;font-weight:900;letter-spacing:.3px}
    .brand .t2{margin:2px 0 0;font-size:12px;color:var(--muted)}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(6,20,18,.55);
      cursor:pointer;
      font-size:12px;
      transition: transform .05s ease, border-color .15s ease, background .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{transform:scale(.98)}
    (‚Ä¶suite √† coller √† partir de)
.btn.primary{background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.22)}
.btn.gold{background: rgba(250,204,21,.12); border-color: rgba(250,204,21,.22)}
.btn.danger{background: rgba(251,113,133,.12); border-color: rgba(251,113,133,.22)}

.panel{
  margin-top:14px;
  border:1px solid var(--line);
  background: rgba(11,42,31,.55);
  backdrop-filter: blur(10px);
  border-radius: var(--r);
  box-shadow: var(--shadow);
  overflow:hidden;
}
.hd{
  padding:12px 12px 10px;
  border-bottom:1px solid rgba(255,255,255,.08);
  display:flex; align-items:flex-start; justify-content:space-between;
  gap:10px; flex-wrap:wrap;
}
.title{font-weight:1000;font-size:16px}
.sub{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35}
.body{padding:12px}
.grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
}
@media (max-width:820px){ .grid{grid-template-columns:1fr} }
.field{
  border:1px solid rgba(255,255,255,.12);
  background: rgba(6,20,18,.45);
  border-radius: 16px;
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.label{font-size:12px;color:var(--muted)}
.input, .select, .ta{
  width:100%;
  padding:12px 12px;
  border-radius: 14px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.16);
  color:var(--text);
  outline:none;
  font-size:14px;
}
.ta{min-height:92px;resize:vertical}
.hint{font-size:12px;color:rgba(234,255,241,.70);line-height:1.35}
.chips{
  display:flex; flex-wrap:wrap; gap:8px; margin-top:4px;
}
.chip{
  display:inline-flex; align-items:center; gap:7px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.16);
  cursor:pointer;
  user-select:none;
  font-size:12px;
}
.chip.on{
  border-color: rgba(250,204,21,.55);
  background: rgba(250,204,21,.12);
}
.chip .k{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.35)}
.chip.on .k{background: var(--gold)}

#map{
  width:100%;
  height: 360px;
  border-radius: 18px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.18);
}

.rowBtns{
  display:flex; gap:10px; flex-wrap:wrap;
  margin-top:12px;
  justify-content:space-between;
  align-items:center;
}
.rowBtns .left, .rowBtns .right{
  display:flex; gap:10px; flex-wrap:wrap;
  align-items:center;
}

.preview{
  margin-top:12px;
  border:1px solid rgba(255,255,255,.12);
  border-radius: 18px;
  background: rgba(6,20,18,.35);
  overflow:hidden;
}
.previewHd{
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,.08);
  font-size:12px;
  color:var(--muted);
  display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
}
.previewBody{padding:12px}
.pLine{font-size:13px;margin:6px 0;color:rgba(234,255,241,.90)}
.muted{color:var(--muted)}
.ok{color:rgba(34,197,94,.92);font-weight:900}
.warn{color:rgba(245,158,11,.95);font-weight:900}

.toast{
  position:fixed; left:50%; transform:translateX(-50%);
  bottom:14px; z-index:80;
  background: rgba(0,0,0,.65);
  border:1px solid rgba(255,255,255,.18);
  color:rgba(234,255,241,.92);
  padding:10px 12px;
  border-radius: 999px;
  backdrop-filter: blur(10px);
  display:none;
  max-width:min(94vw, 820px);
  box-shadow: var(--shadow);
  font-size:13px;
}
.toast.show{display:block}
</style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">‚ôæÔ∏è</div>
        <div>
          <div class="t1">DIGIY EXPLORE</div>
          <div class="t2">Soumettre un Spot ‚Äî SUBMIT V2 (terrain)</div>
        </div>
      </div>
      <div class="actions">
        <div id="btnBack" class="btn">‚¨ÖÔ∏è Retour</div>
        <div id="btnMyPos" class="btn primary">üìç Ma position</div>
        <div id="btnReset" class="btn danger">üßº Reset</div>
      </div>
    </div>

    <div class="panel">
      <div class="hd">
        <div>
          <div class="title">Ajoute un spot (simple + l√©ger)</div>
          <div class="sub">
            Photos en <b>URL</b> (pas d‚Äôupload lourd).<br/>
            Par d√©faut, on envoie en <span class="warn">pending</span> (validation).
          </div>
        </div>
        <div class="hint">üéØ Objectif: faire entrer le terrain en 30 secondes.</div>
      </div>

      <div class="body">
        <div class="grid">
          <div>
            <div class="field">
              <div class="label">Nom du spot *</div>
              <input id="title" class="input" placeholder="Ex: Chez Astou ‚Äî Saly" />
              <div class="hint">Court, clair, identifiable.</div>
            </div>

            <div style="height:10px"></div>

            <div class="field">
              <div class="label">Cat√©gorie *</div>
              <div class="chips" id="chips"></div>
              <div class="hint">Choisis une cat√©gorie terrain.</div>
            </div>

            <div style="height:10px"></div>

            <div class="field">
              <div class="label">Ville *</div>
              <input id="city" class="input" placeholder="Ex: Saly / Dakar / Thi√®s‚Ä¶" />
              <div class="hint">Tu peux mettre ‚ÄúSaly‚Äù tout court, simple.</div>
            </div>

            <div style="height:10px"></div>

            <div class="field">
              <div class="label">T√©l√©phone (WhatsApp) *</div>
              <input id="phone" class="input" placeholder="Ex: +221771234567" />
              <div class="hint">Format conseill√©: <b>+221</b> + num√©ro.</div>
            </div>

            <div style="height:10px"></div>

            <div class="field">
              <div class="label">Adresse / Rep√®re (zone)</div>
              <input id="address" class="input" placeholder="Ex: Route Saly Center, en face..." />
              <div class="hint">On stocke √ßa dans <b>zone</b>.</div>
            </div>

            <div style="height:10px"></div>

            <div class="field">
              <div class="label">Description</div>
              <textarea id="desc" class="ta" placeholder="Ex: poisson brais√©, service rapide, ouvert le soir..."></textarea>
              <div class="hint">Courte, utile, terrain.</div>
            </div>

            <div style="height:10px"></div>

            <div class="field">
              <div class="label">Photos (URL) ‚Äî 1 par ligne</div>
              <textarea id="photos" class="ta" placeholder="https://...jpg
https://...png"></textarea>
              <div class="hint">On garde la 1√®re en <b>photo_url</b> (l√©ger).</div>
            </div>
          </div>

          <div>
            <div class="field">
              <div class="label">Position sur la carte *</div>
              <div id="map"></div>
              <div class="hint">Clique sur la carte pour poser le pin. Ou ‚ÄúMa position‚Äù.</div>
            </div>

            <div style="height:10px"></div>

            <div class="field">
              <div class="label">Latitude / Longitude</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                <input id="lat" class="input" placeholder="lat" />
                <input id="lng" class="input" placeholder="lng" />
              </div>
              <div class="hint">Si tu remplis √† la main, clique ensuite ‚ÄúAper√ßu‚Äù.</div>
            </div>

            <div class="preview">
              <div class="previewHd">
                <div>Aper√ßu (ce qui part dans Supabase)</div>
                <div id="statusLine" class="warn">status: pending</div>
              </div>
              <div class="previewBody" id="previewBody">
                <div class="pLine muted">Remplis le formulaire‚Ä¶</div>
              </div>
            </div>

            <div class="rowBtns">
              <div class="left">
                <div id="btnPreview" class="btn">üëÄ Aper√ßu</div>
              </div>
              <div class="right">
                <div id="btnSubmit" class="btn gold">üöÄ Envoyer (pending)</div>
              </div>
            </div>

            <div class="hint" style="margin-top:10px">
              ‚ö†Ô∏è Public insert = pending (validation).
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* =========================================================
   SUBMIT V2 ‚Äî PATCH SCH√âMA EXISTANT
   Table: public.digiy_explore_spots
   Colonnes:
     name, type, zone, city, lat, lng, badge, description,
     photo_url, phone, link_url, status, owner_phone, tags, score, ambiance, duree, budget
   RLS:
     select -> active
     insert -> pending
   ========================================================= */

const DEFAULT_SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const DEFAULT_SUPABASE_ANON = (localStorage.getItem("DIGIY_SUPABASE_ANON") || "").trim();
const CFG = window.__DIGIY_SUPABASE__ || {};
const SUPABASE_URL = (CFG.url || DEFAULT_SUPABASE_URL).trim();
const SUPABASE_ANON_KEY = (CFG.anon || DEFAULT_SUPABASE_ANON).trim();

let sb = null;
function ensureSupabase(){
  if(sb) return sb;
  if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
    toast("‚ö†Ô∏è Cl√© Supabase manquante. Mets DIGIY_SUPABASE_ANON dans localStorage.");
    throw new Error("Supabase config missing (anon).");
  }
  sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:false } });
  return sb;
}

const $ = (s)=>document.querySelector(s);
const toastEl = $("#toast");
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 2800);
}

function normalizePhone(p){
  if(!p) return "";
  return (p+"").trim().replace(/[^\d+]/g,"");
}
function parsePhotos(text){
  const arr = (text||"").split("\n").map(x=>x.trim()).filter(Boolean).slice(0,9);
  return arr.filter(u => /^https?:\/\//i.test(u));
}
function num(v){
  const n = Number(String(v||"").trim());
  return Number.isFinite(n) ? n : null;
}

/* Categories -> stock√©es dans "type" */
const CATEGORIES = [
  {key:"manger", label:"üç≤ Manger"},
  {key:"dormir", label:"üè† Dormir"},
  {key:"acheter", label:"üõçÔ∏è Acheter"},
  {key:"transport", label:"üöï Transport"},
  {key:"services", label:"üõ†Ô∏è Services"},
  {key:"spots", label:"üèñÔ∏è Spots"},
];

let selectedType = "";
function renderChips(){
  const el = $("#chips");
  el.innerHTML = CATEGORIES.map(c=>`
    <div class="chip ${selectedType===c.key?"on":""}" data-cat="${c.key}">
      <span class="k"></span> ${c.label}
    </div>
  `).join("");
  el.querySelectorAll(".chip").forEach(ch=>{
    ch.addEventListener("click", ()=>{
      selectedType = ch.getAttribute("data-cat") || "";
      renderChips();
      updatePreview();
    });
  });
}

/* Map */
const DEFAULT_CENTER = [14.446, -17.007];
const map = L.map("map", { zoomControl:true }).setView(DEFAULT_CENTER, 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19, attribution: "&copy; OpenStreetMap" }).addTo(map);

let marker = null;
function setMarker(lat,lng){
  const pt = [lat,lng];
  if(marker) map.removeLayer(marker);
  marker = L.marker(pt).addTo(map);
  map.setView(pt, 15);
  $("#lat").value = lat.toFixed(6);
  $("#lng").value = lng.toFixed(6);
}
map.on("click", (e)=>{
  setMarker(e.latlng.lat, e.latlng.lng);
  updatePreview();
});

const STATUS = "pending";

function buildPayload(){
  const name = ($("#title").value || "").trim();
  const city = ($("#city").value || "").trim();
  const phone = normalizePhone($("#phone").value || "");
  const zone = ($("#address").value || "").trim();
  const description = ($("#desc").value || "").trim();
  const photos = parsePhotos($("#photos").value || "");
  const lat = num($("#lat").value);
  const lng = num($("#lng").value);

  return {
    name,
    type: selectedType,                  // ‚úÖ "category" -> "type"
    zone: zone || null,                  // ‚úÖ rep√®re -> zone
    city,
    lat,
    lng,
    description: description || null,
    photo_url: (photos[0] || null),      // ‚úÖ l√©ger: 1 photo
    phone,
    owner_phone: phone || null,          // utile plus tard
    status: STATUS
  };
}

function validatePayload(p){
  const errs = [];
  if(!p.name) errs.push("Nom du spot manquant");
  if(!p.type) errs.push("Cat√©gorie manquante");
  if(!p.city) errs.push("Ville manquante");
  if(!p.phone) errs.push("T√©l√©phone/WhatsApp manquant");
  if(p.lat==null || p.lng==null) errs.push("Position (lat/lng) manquante");
  return errs;
}

function updatePreview(){
  const p = buildPayload();
  const errs = validatePayload(p);
  $("#statusLine").textContent = "status: " + STATUS;

  const lines = [];
  lines.push(`<div class="pLine"><b>name</b>: ${p.name || "‚Äî"}</div>`);
  lines.push(`<div class="pLine"><b>type</b>: ${p.type || "‚Äî"}</div>`);
  lines.push(`<div class="pLine"><b>city</b>: ${p.city || "‚Äî"}</div>`);
  lines.push(`<div class="pLine"><b>zone</b>: <span class="muted">${p.zone || "‚Äî"}</span></div>`);
  lines.push(`<div class="pLine"><b>phone</b>: ${p.phone || "‚Äî"}</div>`);
  lines.push(`<div class="pLine"><b>lat/lng</b>: ${p.lat!=null && p.lng!=null ? (p.lat.toFixed(6)+", "+p.lng.toFixed(6)) : "‚Äî"}</div>`);
  lines.push(`<div class="pLine"><b>photo_url</b>: <span class="muted">${p.photo_url || "‚Äî"}</span></div>`);
  lines.push(`<div class="pLine"><b>description</b>: <span class="muted">${(p.description||"‚Äî").toString().slice(0,120)}</span></div>`);

  if(errs.length){
    lines.push(`<div class="pLine warn">‚ö†Ô∏è ${errs.join(" ‚Ä¢ ")}</div>`);
  } else {
    lines.push(`<div class="pLine ok">‚úÖ Pr√™t √† envoyer (pending)</div>`);
  }
  $("#previewBody").innerHTML = lines.join("");
}

function goMyPos(){
  if(!navigator.geolocation){ toast("G√©olocalisation non support√©e."); return; }
  toast("üìç Localisation‚Ä¶");
  navigator.geolocation.getCurrentPosition(
    (p)=>{
      setMarker(p.coords.latitude, p.coords.longitude);
      updatePreview();
      toast("‚úÖ Position pos√©e.");
    },
    ()=> toast("‚ö†Ô∏è Autorise la localisation."),
    { enableHighAccuracy:true, timeout: 9000, maximumAge: 60000 }
  );
}

async function submit(){
  const sb = ensureSupabase();
  const payload = buildPayload();
  const errs = validatePayload(payload);
  if(errs.length){ toast("‚ö†Ô∏è " + errs[0]); updatePreview(); return; }

  try{
    $("#btnSubmit").textContent = "‚è≥ Envoi‚Ä¶";
    $("#btnSubmit").style.pointerEvents = "none";

    const { data, error } = await sb
      .from("digiy_explore_spots")
      .insert([payload])
      .select("id, name, status")
      .single();

    if(error){
      console.error(error);
      toast("‚ùå Insert refus√© (RLS?)");
      $("#btnSubmit").textContent = "üöÄ Envoyer (pending)";
      $("#btnSubmit").style.pointerEvents = "";
      return;
    }

    toast("‚úÖ Envoy√© ! En attente validation.");
    const spotUrl = `${location.origin}${location.pathname.replace(/\/submit\.html?$/,"/spot.html")}?id=${encodeURIComponent(data.id)}`;
    $("#previewBody").innerHTML = `
      <div class="pLine ok">‚úÖ Spot envoy√© (pending)</div>
      <div class="pLine"><b>id</b>: <span class="muted">${data.id}</span></div>
      <div class="pLine"><b>lien</b>: <span class="muted">${spotUrl}</span></div>
      <div class="pLine muted">Il sera visible sur l‚Äôindex quand tu passes status ‚Üí active.</div>
    `;
    $("#btnSubmit").textContent = "‚úÖ Envoy√©";
  } catch(err){
    console.error(err);
    toast("Erreur r√©seau.");
    $("#btnSubmit").textContent = "üöÄ Envoyer (pending)";
    $("#btnSubmit").style.pointerEvents = "";
  }
}

function resetAll(){
  $("#title").value = "";
  $("#city").value = "";
  $("#phone").value = "";
  $("#address").value = "";
  $("#desc").value = "";
  $("#photos").value = "";
  $("#lat").value = "";
  $("#lng").value = "";
  selectedType = "";
  renderChips();
  if(marker){ map.removeLayer(marker); marker=null; }
  map.setView(DEFAULT_CENTER, 12);
  updatePreview();
  toast("üßº Reset OK");
}

function bind(){
  renderChips();
  updatePreview();

  $("#btnBack").onclick = ()=> history.length>1 ? history.back() : (location.href="./index.html");
  $("#btnMyPos").onclick = goMyPos;
  $("#btnReset").onclick = resetAll;
  $("#btnPreview").onclick = updatePreview;
  $("#btnSubmit").onclick = submit;

  ["title","city","phone","address","desc","photos","lat","lng"].forEach(id=>{
    $("#"+id).addEventListener("input", updatePreview);
  });
}

(function boot(){
  try{ bind(); }
  catch(err){ console.error(err); toast("Erreur d√©marrage (config Supabase?)."); }
})();
</script>
</body>
</html>

